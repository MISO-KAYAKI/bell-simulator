<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ãƒéˆ´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <style>
        /* CSS: Googleã‚µã‚¤ãƒˆã®åŸ‹ã‚è¾¼ã¿iFrameå†…ã§ã‚¯ãƒªãƒƒã‚¯ã—ã‚„ã™ã„ã‚ˆã†ã«èª¿æ•´ */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* åŸ‹ã‚è¾¼ã¿iFrameã®é ˜åŸŸã‚’æ˜ç¢ºã«ã™ã‚‹ */
            min-height: 350px; 
            text-align: center;
            font-family: sans-serif;
            background-color: #f7f7f7;
            padding: 20px;
            margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦åŸ‹ã‚è¾¼ã¿é ˜åŸŸã‚’æœ€å¤§åŒ– */
        }
        h1 {
            font-size: 1.5em;
        }
        #start-button {
            padding: 15px 35px;
            font-size: 1.3em;
            cursor: pointer;
            border: none;
            background-color: #007bff; /* ç›®ç«‹ã¤è‰²ã«å¤‰æ›´ */
            color: white;
            border-radius: 8px;
            margin: 15px 0;
            /* ã‚¿ãƒƒãƒæ“ä½œã—ã‚„ã™ã„ã‚ˆã†ã«å½±ã‚’ä»˜ã‘ã‚‹ */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            transition: background-color 0.3s;
        }
        #start-button:active {
            background-color: #0056b3;
        }
        #status {
            margin-top: 10px;
            font-weight: bold;
            color: #cc0000;
        }
    </style>
</head>
<body>

    <h1>ğŸ» ã‚¯ãƒéˆ´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <p>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚’æºã‚‰ã—ã¦éŸ³ã‚’é³´ã‚‰ã—ã¦ãã ã•ã„ã€‚</p>

    <button id="start-button">ã‚¿ãƒƒãƒ—ã—ã¦ã‚»ãƒ³ã‚µãƒ¼ã¨éŸ³ã‚’æœ‰åŠ¹åŒ–</button>

    <div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­ï¼ˆä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰</div>

    <p>ç¾åœ¨ã®æºã‚Œã®å¼·ã• (m/sÂ²): <span id="acceleration-display">0.00</span></p>
    <p>ç¾åœ¨ã®éŸ³é‡ (ã‚²ã‚¤ãƒ³): <span id="volume-display">0.00</span></p>
    <p>ç¾åœ¨ã®éŸ³è‰² (ãƒ”ãƒƒãƒ/Hz): <span id="pitch-display">0.00</span></p>

    <script>
        // Web Audio APIã®åˆæœŸåŒ–
        // äº’æ›æ€§ã®ãŸã‚ã€ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ (webkit) ã‚‚è€ƒæ…®
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();
        
        let oscillator = null;
        let gainNode = null;
        const baseFrequency = 500; // åŸºæœ¬ã®å‘¨æ³¢æ•° (Hz)

        // HTMLè¦ç´ ã®å‚ç…§
        const startButton = document.getElementById('start-button');
        const statusDisplay = document.getElementById('status');
        const accelerationDisplay = document.getElementById('acceleration-display');
        const volumeDisplay = document.getElementById('volume-display');
        const pitchDisplay = document.getElementById('pitch-display');

        /**
         * Web Audio APIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
         */
        function setupAudio() {
            if (gainNode) return; // æ—¢ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—

            // ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ (éŸ³é‡èª¿æ•´ç”¨)
            gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0, audioContext.currentTime); 
            gainNode.connect(audioContext.destination);

            // ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒ‰ (éŸ³æº)
            oscillator = audioContext.createOscillator();
            oscillator.type = 'sine'; // æ­£å¼¦æ³¢
            oscillator.frequency.setValueAtTime(baseFrequency, audioContext.currentTime);
            oscillator.connect(gainNode);

            // å†ç”Ÿé–‹å§‹
            try {
                oscillator.start();
            } catch (e) {
                console.warn("Oscillator start failed or already started.", e);
            }
        }

        /**
         * ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã—ã€éŸ³é‡ã¨ãƒ”ãƒƒãƒã‚’åˆ¶å¾¡
         */
        function handleMotion(event) {
            // AudioContextãŒå‹•ä½œã—ã¦ã„ãªã„å ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­
            if (!gainNode || audioContext.state !== 'running') return; 

            const acceleration = event.accelerationIncludingGravity;
            if (!acceleration || acceleration.x === null) {
                 statusDisplay.textContent = 'ã‚¨ãƒ©ãƒ¼: ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
                 return;
            }

            // æºã‚Œã®å¼·ã• (é‡åŠ›åŠ é€Ÿåº¦ 9.8m/sÂ² ã‹ã‚‰ã®å¤‰å‹•åˆ†) ã‚’è¨ˆç®—
            const totalAcceleration = Math.sqrt(
                acceleration.x * acceleration.x +
                acceleration.y * acceleration.y +
                acceleration.z * acceleration.z
            );

            // é‡åŠ› (9.8) ã‹ã‚‰ã©ã‚Œã ã‘å¤‰åŒ–ã—ãŸã‹ã‚’ã€Œæºã‚Œã®å¼·ã•ã€ã¨ã™ã‚‹
            const movementStrength = Math.abs(totalAcceleration - 9.8); 
            
            // æºã‚Œã®å¼·ã•ã‚’0.0ã€œ1.0ã«æ­£è¦åŒ–
            const maxMovement = 20; 
            const normalizedMovement = Math.min(movementStrength / maxMovement, 1.0);

            // --- éŸ³é‡ (ã‚²ã‚¤ãƒ³) ã®è¨­å®š ---
            // const maxGain = 0.5;
            const maxGain = 3.0;
            const newGain = normalizedMovement * maxGain;
            gainNode.gain.linearRampToValueAtTime(newGain, audioContext.currentTime + 0.05);

            // --- éŸ³è‰² (ãƒ”ãƒƒãƒ/å‘¨æ³¢æ•°) ã®è¨­å®š ---
            const pitchRange = 100; // å¤‰åŒ–ç¯„å›²
            const newFrequency = baseFrequency + (normalizedMovement * pitchRange);
            oscillator.frequency.linearRampToValueAtTime(newFrequency, audioContext.currentTime + 0.05);

            // ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®æ›´æ–°
            accelerationDisplay.textContent = movementStrength.toFixed(2);
            volumeDisplay.textContent = newGain.toFixed(2);
            pitchDisplay.textContent = newFrequency.toFixed(2);
        }

        /**
         * ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
         */
        startButton.addEventListener('click', async () => {
            // 1. AudioContextã®å†é–‹ (è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼å¯¾ç­–)
            if (audioContext.state === 'suspended') {
                await audioContext.resume().catch(e => {
                    console.error("AudioContext resume failed:", e);
                    statusDisplay.textContent = 'ã‚¨ãƒ©ãƒ¼: éŸ³å£°å†ç”Ÿã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    return;
                });
            }

            // 2. ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ã®æ¨©é™è¦æ±‚ (iOS 13+ ã®ã¿)
            let permissionGranted = true;
            
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState !== 'granted') {
                        permissionGranted = false;
                        statusDisplay.textContent = 'ã‚¨ãƒ©ãƒ¼: ã‚»ãƒ³ã‚µãƒ¼æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    }
                } catch (e) {
                    // requestPermissionãŒåˆ©ç”¨å¯èƒ½ã ãŒå¤±æ•—ã—ãŸå ´åˆ
                    console.error("Permission request failed:", e);
                }
            }
            
            // Androidã‚„æ¨©é™è¦æ±‚ãŒä¸è¦ãªç’°å¢ƒã€ã¾ãŸã¯æ¨©é™ãŒè¨±å¯ã•ã‚ŒãŸå ´åˆ
            if (permissionGranted) {
                setupAudio(); // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                window.addEventListener('devicemotion', handleMotion);
                
                statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å®Ÿè¡Œä¸­ï¼ãƒ‡ãƒã‚¤ã‚¹ã‚’æºã‚‰ã—ã¦ãã ã•ã„ã€‚';
                startButton.textContent = 'æœ‰åŠ¹åŒ–æ¸ˆã¿';
                startButton.disabled = true;
                startButton.style.backgroundColor = '#28a745'; // æˆåŠŸã—ãŸè‰²
            }
        });
    </script>
</body>
</html>
