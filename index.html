<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ãƒéˆ´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (3ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼èª¿æ•´ç‰ˆ)</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 350px; 
            text-align: center;
            font-family: sans-serif;
            background-color: #f7f7f7;
            padding: 20px;
            margin: 0;
        }
        h1 {
            font-size: 1.5em;
        }
        #toggle-button {
            padding: 15px 35px;
            font-size: 1.3em;
            cursor: pointer;
            border: none;
            color: white;
            border-radius: 8px;
            margin: 15px 0 25px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            transition: background-color 0.3s;
        }
        #toggle-button[data-state="stopped"] {
            background-color: #007bff; /* é’ */
        }
        #toggle-button[data-state="running"] {
            background-color: #dc3545; /* èµ¤ */
        }
        #toggle-button:active {
            opacity: 0.8;
        }
        #status {
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .slider-control {
            margin: 10px 0;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            width: 300px;
            text-align: left;
        }
        .slider-control label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .slider-control input[type="range"] {
            width: 100%;
        }
    </style>
</head>
<body>

    <h1>ğŸ» ã‚¯ãƒéˆ´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (3ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼èª¿æ•´ç‰ˆ)</h1>
    <p>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚’æºã‚‰ã—ã¦éŸ³ã‚’é³´ã‚‰ã—ã¦ãã ã•ã„ã€‚</p>

    <button id="toggle-button" data-state="stopped">ã‚¿ãƒƒãƒ—ã—ã¦ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹åŒ–</button>

    <div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­ï¼ˆä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰</div>

    <div class="slider-control">
        <label for="decay-slider">ä½™éŸ»æ™‚é–“ (Release Time):</label>
        <input type="range" id="decay-slider" min="0.5" max="2.0" step="0.1" value="2.0">
        <span id="decay-display">2.0</span> ç§’
    </div>

    <div class="slider-control">
        <label for="freq-low-slider">ä½å‘¨æ³¢æ•° (Low Freq):</label>
        <input type="range" id="freq-low-slider" min="440" max="640" step="10" value="540">
        <span id="freq-low-display">540</span> Hz
    </div>

    <div class="slider-control">
        <label for="freq-high-slider">é«˜å‘¨æ³¢æ•° (High Freq):</label>
        <input type="range" id="freq-high-slider" min="700" max="900" step="10" value="800">
        <span id="freq-high-display">800</span> Hz
    </div>
    
    <hr style="width: 80%; margin: 20px 0;">

    <p>ç¾åœ¨ã®æºã‚Œã®å¼·ã• (m/sÂ²): <span id="acceleration-display">0.00</span></p>
    <p>ç¾åœ¨ã®éŸ³é‡ (ã‚²ã‚¤ãƒ³): <span id="volume-display">0.00</span></p>
    <p>ç¾åœ¨ã®éŸ³è‰² (ä½ãƒ”ãƒƒãƒ/Hz): <span id="pitch-display">0.00</span></p>

    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();
        
        // â˜… å¤‰æ›´ç‚¹ 2: å‘¨æ³¢æ•°ã‚‚å‹•çš„ã«å¤‰æ›´ã•ã‚Œã‚‹ã‚ˆã†ã« let ã§å®£è¨€
        let COWBELL_DURATION = 2.0; 
        let FREQ_LOW = 540;   
        let FREQ_HIGH = 800;  
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‘¨æ³¢æ•°ã¯å›ºå®š
        const FILTER_FREQ = 2500; 
        
        let isSounding = false; // é€£æ‰“é˜²æ­¢ãƒ•ãƒ©ã‚°

        const toggleButton = document.getElementById('toggle-button');
        const statusDisplay = document.getElementById('status');
        const accelerationDisplay = document.getElementById('acceleration-display');
        const volumeDisplay = document.getElementById('volume-display');
        const pitchDisplay = document.getElementById('pitch-display');
        
        // è¦ç´ ã®å‚ç…§
        const decaySlider = document.getElementById('decay-slider');
        const decayDisplay = document.getElementById('decay-display');
        const freqLowSlider = document.getElementById('freq-low-slider');
        const freqLowDisplay = document.getElementById('freq-low-display');
        const freqHighSlider = document.getElementById('freq-high-slider');
        const freqHighDisplay = document.getElementById('freq-high-display');
        
        // â˜… å¤‰æ›´ç‚¹ 3: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        
        // ä½™éŸ»æ™‚é–“ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        decaySlider.addEventListener('input', (e) => {
            COWBELL_DURATION = parseFloat(e.target.value);
            decayDisplay.textContent = COWBELL_DURATION.toFixed(1);
        });
        
        // ä½å‘¨æ³¢æ•°ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        freqLowSlider.addEventListener('input', (e) => {
            FREQ_LOW = parseInt(e.target.value);
            freqLowDisplay.textContent = FREQ_LOW;
        });
        
        // é«˜å‘¨æ³¢æ•°ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        freqHighSlider.addEventListener('input', (e) => {
            FREQ_HIGH = parseInt(e.target.value);
            freqHighDisplay.textContent = FREQ_HIGH;
        });


        /**
         * Web Audio APIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— 
         */
        function setupAudio() {
             if (audioContext.state === 'suspended') {
                audioContext.resume();
             }
        }

        /**
         * æºã‚ŒãŒæ¤œçŸ¥ã•ã‚ŒãŸã¨ãã«ã‚«ã‚¦ãƒ™ãƒ«ã®éŸ³ã‚’é³´ã‚‰ã™
         */
        function playCowbellSound() {
            const now = audioContext.currentTime;
            
            // ã‚«ã‚¦ãƒ™ãƒ«éŸ³è‰²ãƒ­ã‚¸ãƒƒã‚¯: COWBELL_DURATION, FREQ_LOW, FREQ_HIGHãŒå‹•çš„ã«å‚ç…§ã•ã‚Œã‚‹

            const gainNode = audioContext.createGain();
            gainNode.connect(audioContext.destination);
            gainNode.gain.setValueAtTime(0.01, now); 
            gainNode.gain.linearRampToValueAtTime(0.5, now + 0.005); 
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + COWBELL_DURATION); 

            const filter = audioContext.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.setValueAtTime(FILTER_FREQ, now);
            filter.Q.setValueAtTime(5, now);
            filter.connect(gainNode);

            const osc1 = audioContext.createOscillator();
            osc1.type = 'square';
            osc1.frequency.setValueAtTime(FREQ_LOW, now); // â˜… FREQ_LOWã‚’é©ç”¨
            osc1.connect(filter);
            
            const osc2 = audioContext.createOscillator();
            osc2.type = 'square';
            osc2.frequency.setValueAtTime(FREQ_HIGH, now); // â˜… FREQ_HIGHã‚’é©ç”¨
            osc2.connect(filter);
            
            osc1.start(now);
            osc2.start(now);
            osc1.stop(now + COWBELL_DURATION);
            osc2.stop(now + COWBELL_DURATION);

            // --- è¡¨ç¤ºã¨é€£æ‰“é˜²æ­¢ãƒ•ãƒ©ã‚°ã®ãƒªã‚»ãƒƒãƒˆ ---
            isSounding = true;
            volumeDisplay.textContent = '0.50';
            // ä»£è¡¨å€¤ã¨ã—ã¦ä½ã„å‘¨æ³¢æ•°ã‚’è¡¨ç¤º
            pitchDisplay.textContent = FREQ_LOW.toFixed(0); 

            setTimeout(() => {
                isSounding = false;
                volumeDisplay.textContent = '0.00';
                pitchDisplay.textContent = '0.00';
            }, COWBELL_DURATION * 1000);
        }

        /**
         * ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
         */
        function handleMotion(event) {
            if (audioContext.state !== 'running') return; 

            const acceleration = event.accelerationIncludingGravity;
            if (!acceleration || acceleration.x === null) {
                 statusDisplay.textContent = 'ã‚¨ãƒ©ãƒ¼: ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
                 return;
            }

            // æºã‚Œã®å¼·ã• (m/sÂ²) ã‚’è¨ˆç®—
            const totalAcceleration = Math.sqrt(
                acceleration.x * acceleration.x +
                acceleration.y * acceleration.y +
                acceleration.z * acceleration.z
            );
            const movementStrength = Math.abs(totalAcceleration - 9.8); 
            const maxMovement = 20; 
            const normalizedMovement = Math.min(movementStrength / maxMovement, 1.0);

            // æºã‚Œã®è¡¨ç¤ºã¯å¸¸ã«æ›´æ–°
            accelerationDisplay.textContent = movementStrength.toFixed(2);

            // æºã‚Œã®æ„Ÿåº¦é–¾å€¤
            const SENSITIVITY_THRESHOLD = 0.02; 
            
            if (normalizedMovement > SENSITIVITY_THRESHOLD) {
                
                if (isSounding) {
                    return; 
                }

                // ã‚«ã‚¦ãƒ™ãƒ«ã®éŸ³ã‚’é³´ã‚‰ã™
                playCowbellSound();
            }
            
            // éŸ³ãŒé³´ã£ã¦ã„ãªã„ã¨ãã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¨ãƒ”ãƒƒãƒã‚’ãƒªã‚»ãƒƒãƒˆ
            if (!isSounding) {
                 volumeDisplay.textContent = '0.00';
                 pitchDisplay.textContent = '0.00'; 
            }
        }

        /**
         * ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ã®æ©Ÿèƒ½ã®é–‹å§‹å‡¦ç†
         */
        async function startSimulator() {
            if (audioContext.state === 'suspended') {
                await audioContext.resume().catch(e => {
                    statusDisplay.textContent = 'ã‚¨ãƒ©ãƒ¼: éŸ³å£°å†ç”Ÿã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    return;
                });
            }

            let permissionGranted = true;
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState !== 'granted') {
                        permissionGranted = false;
                    }
                } catch (e) {
                    
                }
            }
            
            if (permissionGranted) {
                setupAudio(); 
                window.addEventListener('devicemotion', handleMotion); 
                
                toggleButton.setAttribute('data-state', 'running');
                toggleButton.textContent = 'å‹•ä½œã‚’ä¸€æ™‚åœæ­¢ (éŸ³ãŒé³´ã‚Šã¾ã™)';
                statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å®Ÿè¡Œä¸­ï¼ãƒ‡ãƒã‚¤ã‚¹ã‚’æºã‚‰ã—ã¦ãã ã•ã„ã€‚';
            }
        }

        /**
         * ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ã®æ©Ÿèƒ½ã®åœæ­¢å‡¦ç†
         */
        function stopSimulator() {
            window.removeEventListener('devicemotion', handleMotion); 
            
            isSounding = false; // ãƒ•ãƒ©ã‚°ã‚‚ãƒªã‚»ãƒƒãƒˆ

            // ç”»é¢ã®è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            accelerationDisplay.textContent = '0.00';
            volumeDisplay.textContent = '0.00';
            pitchDisplay.textContent = '0.00'; 
            
            toggleButton.setAttribute('data-state', 'stopped');
            toggleButton.textContent = 'å‹•ä½œã‚’å†é–‹';
            statusDisplay.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: åœæ­¢ä¸­ï¼ˆã‚»ãƒ³ã‚µãƒ¼ç„¡åŠ¹ï¼‰';
        }


        /**
         * ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
         */
        toggleButton.addEventListener('click', () => {
            const currentState = toggleButton.getAttribute('data-state');
            
            if (currentState === 'stopped') {
                startSimulator(); 
            } else {
                stopSimulator(); 
            }
        });
    </script>
</body>
</html>
